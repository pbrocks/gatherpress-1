(()=>{"use strict";var e={n:t=>{var n=t&&t.__esModule?()=>t.default:()=>t;return e.d(n,{a:n}),n},d:(t,n)=>{for(var r in n)e.o(n,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:n[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=window.wp.element,n=window.wp.i18n,r=window.wp.data,a=window.wp.components,s=window.wp.plugins,o=window.wp.editPost,l=window.moment;var i=e.n(l);const c=window.wp.apiFetch;var m=e.n(c);function u(){(0,r.dispatch)("core/editor").editPost({meta:{_non_existing_meta:!0}})}function d(e){if("object"==typeof GatherPress)return e.split(".").reduce(((e,t)=>e&&e[t]),GatherPress)}function p(e,t){if("object"!=typeof GatherPress)return;const n=e.split("."),r=n.pop();n.reduce(((e,t)=>{var n;return null!==(n=e[t])&&void 0!==n?n:e[t]={}}),GatherPress)[r]=t}const g="YYYY-MM-DDTHH:mm:ss",_="YYYY-MM-DD HH:mm:ss",v="MMMM D, YYYY h:mm a",E=(e=d("event_datetime.timezone"))=>i().tz.zone(e)?e:(0,n.__)("GMT","gatherpress"),h=(e="")=>{const t=/^(\+|-)(\d{2}):(00|15|30|45)$/,n=e.replace(t,"$1");return n!==e?"UTC"+n+parseInt(e.replace(t,"$2")).toString()+e.replace(t,"$3").replace("00","").replace("15",".25").replace("30",".5").replace("45",".75"):e},f=i().tz(E()).add(1,"day").set("hour",18).set("minute",0).set("second",0).format(g),S=i().tz(f,E()).add(2,"hours").format(g),b=(e,t=null)=>{!function(e){const t=i().tz(d("event_datetime.datetime_end"),E()).valueOf(),n=i().tz(e,E()).valueOf();if(n>=t){const e=i().tz(n,E()).add(2,"hours").format(g);T(e)}}(e),p("event_datetime.datetime_start",e),"function"==typeof t&&t(e),u()},T=(e,t=null)=>{!function(e){const t=i().tz(d("event_datetime.datetime_start"),E()).valueOf(),n=i().tz(e,E()).valueOf();if(n<=t){const e=i().tz(n,E()).subtract(2,"hours").format(g);b(e)}}(e),p("event_datetime.datetime_end",e),null!==t&&t(e),u()};function w(){const e=(0,r.select)("core/editor").isSavingPost(),t=(0,r.select)("core/editor").isAutosavingPost();C()&&e&&!t&&m()({path:"/gatherpress/v1/event/datetime/",method:"POST",data:{post_id:d("post_id"),datetime_start:i().tz(d("event_datetime.datetime_start"),E()).format(_),datetime_end:i().tz(d("event_datetime.datetime_end"),E()).format(_),timezone:d("event_datetime.timezone"),_wpnonce:d("nonce")}}).then((()=>{!function(){const e="gp_event_communcation",t=(0,r.dispatch)("core/notices");t.removeNotice(e),"publish"!==(0,r.select)("core/editor").getEditedPostAttribute("status")||D()||t.createNotice("success",(0,n.__)("Send an event update to members via email?","gatherpress"),{id:e,isDismissible:!0,actions:[{onClick:()=>{P({setOpen:!0})},label:(0,n.__)("Compose Message","gatherpress")}]})}()}))}const P=(e,t=!1)=>{for(const[n,r]of Object.entries(e)){let e=n;t&&(e+=t);const a=new CustomEvent(e,{detail:r});dispatchEvent(a)}},z=(e,t=!1)=>{for(const[n,r]of Object.entries(e)){let e=n;t&&(e+=t),addEventListener(e,(e=>{r(e.detail)}),!1)}};function C(){return"gp_event"===(0,r.select)("core/editor").getCurrentPostType()}function D(){const e=i()(d("event_datetime.datetime_end"));return i().tz(E()).valueOf()>e.tz(E()).valueOf()}function O(){const e="gp_event_past",t=(0,r.dispatch)("core/notices");t.removeNotice(e),D()&&t.createNotice("warning",(0,n.__)("This event has already past.","gatherpress"),{id:e,isDismissible:!1})}const y=()=>{const[e,s]=(0,t.useState)(""),[o,l]=(0,t.useState)(""),[i,c]=(0,t.useState)(""),[m,u]=(0,t.useState)(""),[d,p]=(0,t.useState)(!1),[g,_]=(0,t.useState)(""),v=(0,r.useDispatch)("core/editor").editPost,{unlockPostSaving:E}=(0,r.useDispatch)("core/editor"),h=(0,r.useSelect)((e=>e("core/editor").getEditedPostAttribute("_gp_venue"))),f=(0,r.useSelect)((e=>e("core").getEntityRecord("taxonomy","_gp_venue",h))),S=f?.slug.replace(/^_/,""),[b,T]=(0,t.useState)(""),w=h+":"+b,z=(0,r.useSelect)((e=>e("core").getEntityRecords("postType","gp_venue",{per_page:1,slug:b})));(0,t.useEffect)((()=>{var e,t,r,a,o;let i={};if(b&&Array.isArray(z)){var m;const e=null!==(m=z[0]?.meta?._venue_information)&&void 0!==m?m:"{}";var d;e&&(i=JSON.parse(e),i.name=null!==(d=z[0]?.title.rendered)&&void 0!==d?d:"")}const p=null!==(e=i?.name)&&void 0!==e?e:(0,n.__)("No venue selected.","gatherpress"),g=null!==(t=i?.fullAddress)&&void 0!==t?t:"",v=null!==(r=i?.phoneNumber)&&void 0!==r?r:"",E=null!==(a=i?.website)&&void 0!==a?a:"";S&&T(S),_(null!==(o=String(w))&&void 0!==o?o:""),s(p),l(g),c(v),u(E),P({setName:p,setFullAddress:g,setPhoneNumber:v,setWebsite:E,setIsOnlineEventTerm:"online-event"===b})}),[b,z,S,w]);let C=(0,r.useSelect)((e=>e("core").getEntityRecords("taxonomy","_gp_venue",{per_page:-1,context:"view"})),[]);return C?(C=C.map((e=>({label:e.name,value:e.id+":"+e.slug.replace(/^_/,"")}))),C.unshift({value:":",label:(0,n.__)("Choose a venue","gatherpress")})):C=[],(0,t.createElement)(a.PanelRow,null,(0,t.createElement)(a.SelectControl,{label:(0,n.__)("Venue Selector","gatherpress"),value:g,onChange:e=>{(e=>{_(e);const t=""!==(e=e.split(":"))[0]?[e[0]]:[];v({_gp_venue:t}),T(e[1]),E()})(e)},options:C}))},k=()=>(0,t.createElement)("section",null,(0,t.createElement)(y,null)),x=()=>{const{editPost:e,unlockPostSaving:s}=(0,r.useDispatch)("core/editor"),o=(0,r.useSelect)((e=>e("core/editor").getEditedPostAttribute("meta")._online_event_link)),[l,i]=(0,t.useState)(o);return z({setOnlineEventLink:i},d("post_id")),(0,t.createElement)(a.TextControl,{label:(0,n.__)("Online event link","gatherpress"),value:l,placeholder:(0,n.__)("Add link to online event","gatherpress"),onChange:t=>{(t=>{e({meta:{_online_event_link:t}}),i(t),P({setOnlineEventLink:t},d("post_id")),s()})(t)}})},N=()=>(0,t.createElement)("section",null,(0,t.createElement)(x,null)),A=window.wp.date,F=e=>{const{dateTimeStart:t}=e;return i().tz(t,E()).format(v)},M=e=>{const{dateTimeEnd:t}=e;return i().tz(t,E()).format(v)},Y=e=>{const{dateTimeStart:n,setDateTimeStart:r}=e,s=(0,A.getSettings)(),o=/a(?!\\)/i.test(s.formats.time.toLowerCase().replace(/\\\\/g,"").split("").reverse().join(""));return(0,t.createElement)(a.DateTimePicker,{currentDate:n,onChange:e=>b(e,r),is12Hour:o})},j=e=>{const{dateTimeEnd:n,setDateTimeEnd:r}=e,s=(0,A.getSettings)(),o=/a(?!\\)/i.test(s.formats.time.toLowerCase().replace(/\\\\/g,"").split("").reverse().join(""));return(0,t.createElement)(a.DateTimePicker,{currentDate:n,onChange:e=>T(e,r),is12Hour:o})},$=e=>{const{dateTimeStart:r,setDateTimeStart:s}=e;return(0,t.useEffect)((()=>{s(i().tz((()=>{let e=d("event_datetime.datetime_start");return e=""!==e?i().tz(e,E()).format(g):f,p("event_datetime.datetime_start",e),e})(),E()).format(g)),P({setDateTimeStart:r}),O()})),(0,t.createElement)(a.PanelRow,null,(0,t.createElement)(a.Flex,null,(0,t.createElement)(a.FlexItem,null,(0,n.__)("Start","gatherpress")),(0,t.createElement)(a.FlexItem,null,(0,t.createElement)(a.Dropdown,{position:"bottom left",renderToggle:({isOpen:e,onToggle:n})=>(0,t.createElement)(a.Button,{onClick:n,"aria-expanded":e,isLink:!0},(0,t.createElement)(F,{dateTimeStart:r})),renderContent:()=>(0,t.createElement)(Y,{dateTimeStart:r,setDateTimeStart:s})}))))},L=e=>{const{dateTimeEnd:r,setDateTimeEnd:s}=e;return(0,t.useEffect)((()=>{s(i().tz((()=>{let e=d("event_datetime.datetime_end");return e=""!==e?i().tz(e,E()).format(g):S,p("event_datetime.datetime_end",e),e})(),E()).format(g)),P({setDateTimeEnd:r}),O()})),(0,t.createElement)(a.PanelRow,null,(0,t.createElement)(a.Flex,null,(0,t.createElement)(a.FlexItem,null,(0,n.__)("End","gatherpress")),(0,t.createElement)(a.FlexItem,null,(0,t.createElement)(a.Dropdown,{position:"bottom left",renderToggle:({isOpen:e,onToggle:n})=>(0,t.createElement)(a.Button,{onClick:n,"aria-expanded":e,isLink:!0},(0,t.createElement)(M,{dateTimeEnd:r})),renderContent:()=>(0,t.createElement)(j,{dateTimeEnd:r,setDateTimeEnd:s})}))))},R=e=>{const{timezone:r,setTimezone:s}=e,o=d("timezone_choices");return(0,t.useEffect)((()=>{s(d("event_datetime.timezone"))}),[s]),(0,t.useEffect)((()=>{P({setTimezone:d("event_datetime.timezone")})})),(0,t.createElement)(a.PanelRow,null,(0,t.createElement)(a.SelectControl,{label:(0,n.__)("Time Zone","gatherpress"),value:h(r),onChange:e=>{e=((e="")=>{const t=/^UTC(\+|-)(\d+)(.\d+)?$/,n=e.replace(t,"$1");if(n!==e){const r=e.replace(t,"$2").padStart(2,"0");let a=e.replace(t,"$3");return""===a&&(a=":00"),a=a.replace(".25",":15").replace(".5",":30").replace(".75",":45"),n+r+a}return e})(e),s(e),p("event_datetime.timezone",e),u()}},Object.keys(o).map((e=>(0,t.createElement)("optgroup",{key:e,label:e},Object.keys(o[e]).map((n=>(0,t.createElement)("option",{key:n,value:n},o[e][n]))))))))},H=()=>{const[e,a]=(0,t.useState)(),[s,o]=(0,t.useState)(),[l,i]=(0,t.useState)();return(0,r.subscribe)(w),(0,t.createElement)(t.Fragment,null,(0,t.createElement)("section",null,(0,t.createElement)("h3",null,(0,n.__)("Date & time","gatherpress")),(0,t.createElement)($,{dateTimeStart:e,setDateTimeStart:a}),(0,t.createElement)(L,{dateTimeEnd:s,setDateTimeEnd:o})),(0,t.createElement)("section",null,(0,t.createElement)(R,{timezone:l,setTimezone:i})))},I=()=>(0,t.createElement)("section",null,(0,t.createElement)(H,null)),G=()=>"publish"===(0,r.select)("core/editor").getEditedPostAttribute("status")&&!D()&&(0,t.createElement)("section",null,(0,t.createElement)("h3",{style:{marginBottom:"0.5rem"}},(0,n.__)("Send an event update","gatherpress")),(0,t.createElement)(a.Button,{variant:"secondary",onClick:()=>P({setOpen:!0})},(0,n.__)("Compose Message","gatherpress")));(0,s.registerPlugin)("gp-event-settings",{render:()=>C()&&(0,t.createElement)(o.PluginDocumentSettingPanel,{name:"gp-event-settings",title:(0,n.__)("Event settings","gatherpress"),initialOpen:!0,className:"gp-event-settings"},(0,t.createElement)(a.__experimentalVStack,{spacing:6},(0,t.createElement)(I,null),(0,t.createElement)(k,null),(0,t.createElement)(N,null),(0,t.createElement)(G,null)))}),(0,r.dispatch)("core/edit-post").toggleEditorPanelOpened("gp-event-settings/gp-event-settings");const B=()=>{var e,s,o;const l=(0,r.useDispatch)("core/editor").editPost,i=(e,t)=>{const n=JSON.stringify({...c,[e]:t});l({meta:{_venue_information:n}})};let c=(0,r.useSelect)((e=>e("core/editor").getEditedPostAttribute("meta")._venue_information));c=c?JSON.parse(c):{};const[m,u]=(0,t.useState)(null!==(e=c.fullAddress)&&void 0!==e?e:""),[d,p]=(0,t.useState)(null!==(s=c.phoneNumber)&&void 0!==s?s:""),[g,_]=(0,t.useState)(null!==(o=c.website)&&void 0!==o?o:"");return z({setFullAddress:u,setPhoneNumber:p,setWebsite:_}),(0,t.createElement)(t.Fragment,null,(0,t.createElement)(a.TextControl,{label:(0,n.__)("Full Address","gatherpress"),value:m,onChange:e=>{P({setFullAddress:e}),i("fullAddress",e)}}),(0,t.createElement)(a.TextControl,{label:(0,n.__)("Phone Number","gatherpress"),value:d,onChange:e=>{P({setPhoneNumber:e}),i("phoneNumber",e)}}),(0,t.createElement)(a.TextControl,{label:(0,n.__)("Website","gatherpress"),value:g,type:"url",onChange:e=>{P({setWebsite:e}),i("website",e)}}))},V=()=>(0,t.createElement)("section",null,(0,t.createElement)(B,null));(0,s.registerPlugin)("gp-venue-settings",{render:()=>"gp_venue"===(0,r.select)("core/editor").getCurrentPostType()&&(0,t.createElement)(o.PluginDocumentSettingPanel,{name:"gp-venue-settings",title:(0,n.__)("Venue settings","gatherpress"),initialOpen:!0,className:"gp-venue-settings"},(0,t.createElement)(a.__experimentalVStack,{spacing:6},(0,t.createElement)(V,null)))}),(0,r.dispatch)("core/edit-post").toggleEditorPanelOpened("gp-venue-settings/gp-venue-settings")})();